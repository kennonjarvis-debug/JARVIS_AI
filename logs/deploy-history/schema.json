{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Jarvis Deployment History Schema",
  "description": "Schema for logging Jarvis deployment history",
  "type": "object",
  "required": [
    "deployment_id",
    "timestamp",
    "status",
    "environment",
    "commit"
  ],
  "properties": {
    "deployment_id": {
      "type": "string",
      "description": "Unique deployment identifier (e.g., GitHub run ID)",
      "pattern": "^[a-zA-Z0-9_-]+$"
    },
    "timestamp": {
      "type": "string",
      "description": "ISO 8601 timestamp of deployment",
      "format": "date-time"
    },
    "status": {
      "type": "string",
      "description": "Overall deployment status",
      "enum": ["success", "failure", "partial", "cancelled", "skipped"]
    },
    "environment": {
      "type": "string",
      "description": "Deployment environment",
      "enum": ["development", "staging", "production"]
    },
    "commit": {
      "type": "object",
      "description": "Git commit information",
      "required": ["sha", "message", "author"],
      "properties": {
        "sha": {
          "type": "string",
          "description": "Git commit SHA",
          "pattern": "^[a-f0-9]{7,40}$"
        },
        "message": {
          "type": "string",
          "description": "Commit message"
        },
        "author": {
          "type": "string",
          "description": "Commit author"
        },
        "url": {
          "type": "string",
          "description": "URL to commit",
          "format": "uri"
        }
      }
    },
    "health": {
      "type": "object",
      "description": "Pre-deployment health metrics",
      "properties": {
        "pre_deploy_vitality": {
          "type": "number",
          "description": "Jarvis vitality score before deployment",
          "minimum": 0,
          "maximum": 100
        },
        "post_deploy_vitality": {
          "type": "number",
          "description": "Jarvis vitality score after deployment",
          "minimum": 0,
          "maximum": 100
        },
        "deploy_allowed": {
          "type": "boolean",
          "description": "Whether deployment was allowed based on health"
        },
        "health_check_passed": {
          "type": "boolean",
          "description": "Whether post-deployment health check passed"
        }
      }
    },
    "jobs": {
      "type": "object",
      "description": "Status of individual CI/CD jobs",
      "properties": {
        "lint": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "unit_tests": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "integration_tests": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "e2e_tests": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "security_scan": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "build": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "deploy": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "sync_memory": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        },
        "notify": {
          "type": "string",
          "enum": ["success", "failure", "skipped", "cancelled"]
        }
      }
    },
    "metrics": {
      "type": "object",
      "description": "Deployment performance metrics",
      "properties": {
        "duration_seconds": {
          "type": "number",
          "description": "Total deployment duration in seconds",
          "minimum": 0
        },
        "build_time_seconds": {
          "type": "number",
          "description": "Build time in seconds",
          "minimum": 0
        },
        "test_time_seconds": {
          "type": "number",
          "description": "Total test time in seconds",
          "minimum": 0
        },
        "deploy_time_seconds": {
          "type": "number",
          "description": "Actual deployment time in seconds",
          "minimum": 0
        }
      }
    },
    "backup": {
      "type": "object",
      "description": "Memory backup information",
      "properties": {
        "sync_performed": {
          "type": "boolean",
          "description": "Whether memory sync was performed"
        },
        "backup_size_mb": {
          "type": "number",
          "description": "Size of backup in megabytes",
          "minimum": 0
        },
        "files_synced": {
          "type": "integer",
          "description": "Number of files synced",
          "minimum": 0
        },
        "s3_url": {
          "type": "string",
          "description": "S3 URL of backup",
          "format": "uri"
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Additional deployment metadata",
      "properties": {
        "workflow_url": {
          "type": "string",
          "description": "URL to CI/CD workflow run",
          "format": "uri"
        },
        "triggered_by": {
          "type": "string",
          "description": "What triggered the deployment",
          "enum": ["push", "pull_request", "release", "schedule", "workflow_dispatch"]
        },
        "branch": {
          "type": "string",
          "description": "Git branch deployed"
        },
        "skip_tests": {
          "type": "boolean",
          "description": "Whether tests were skipped"
        },
        "rollback_from": {
          "type": "string",
          "description": "Previous deployment ID if this is a rollback"
        },
        "tags": {
          "type": "array",
          "description": "Custom tags for categorization",
          "items": {
            "type": "string"
          }
        },
        "notes": {
          "type": "string",
          "description": "Additional notes about the deployment"
        }
      }
    },
    "errors": {
      "type": "array",
      "description": "Errors encountered during deployment",
      "items": {
        "type": "object",
        "required": ["stage", "message"],
        "properties": {
          "stage": {
            "type": "string",
            "description": "CI/CD stage where error occurred"
          },
          "message": {
            "type": "string",
            "description": "Error message"
          },
          "stack_trace": {
            "type": "string",
            "description": "Stack trace if available"
          },
          "timestamp": {
            "type": "string",
            "format": "date-time"
          }
        }
      }
    },
    "notifications": {
      "type": "object",
      "description": "Notification delivery status",
      "properties": {
        "slack_sent": {
          "type": "boolean",
          "description": "Whether Slack notification was sent"
        },
        "email_sent": {
          "type": "boolean",
          "description": "Whether email notification was sent"
        },
        "notification_errors": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    }
  }
}
